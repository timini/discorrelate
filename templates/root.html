<!doctype html>
<head>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js"></script>
<style type="text/css">
svg{
  position:absolute;
  top:0;
  left:0;
  z-index:-1;
}
form{
  position:absolute;
  left:1em;
  top:1em;
}
form p label {
  width:100px;
  display:inline-block;
  text-align:right;
}
form input[value="find"]{
  margin-left:106px;
}
circle {
  stroke-width: 1.5px;
}

line {
  stroke: #999;
}
.nodetext { pointer-events: none; font: 10px sans-serif; }

</style>
<script type="text/javascript">
$(document).ready(function(data) {
	$('form').submit(function(e){
		e.preventDefault();
		var url = $('input[name="url"]').val();
		var year = $('input[name="year"]').val();
		var query = $('select[name="query"]').val();
		var csrfmiddlewaretoken = $('input[name="csrfmiddlewaretoken"]').val();
		$.ajax({
			type : 'POST',
			url : '/',
			data: {
				url : url,
				year : year,
				query : query,
				csrfmiddlewaretoken : csrfmiddlewaretoken
			},
			success : function(json){
				var w = $(window).width(),
			    h = $(window).height(),
			    r = 10,
			    fill = d3.scale.category20();

			var force = d3.layout.force()
			    .gravity(.01)
			    .charge(-50)
			    .linkDistance(60)
			    .size([w, h]);

			var svg = d3.select("body").append("svg:svg")
			    .attr("width", w)
			    .attr("height", h);

			var link = svg.selectAll("line")
			    .data(json.links)
			    .enter().append("svg:line");

			var node = svg.selectAll("g.node")
			    .data(json.nodes)
			    .enter().append("svg:g")
			    .attr("class", "node")
			    .call(force.drag);
			
			node
				.append("svg:circle")
				.attr("r", r - .75)
				.style("fill", function(d) { return fill(d.group); })
				.style("stroke", function(d) { return d3.rgb(fill(d.group)).darker(); });
			
			node
				.append("svg:title")
		        .text(function(d) { return d.artist; });
			
			node
				.append("svg:text")
				.attr("class", "nodetext")
			    .attr("dx", 12)
			    .attr("dy", ".3em")
			    .text(function(d) { return d.name; });

			force
			    .nodes(json.nodes)
			    .links(json.links)
			    .on("tick", tick)
			    .start();

			  function tick() {
				  
				force.start();
				
			    node
			        .attr("transform", function(d) { 
			        	//return "translate(" + ((d.x - d.px)+w/2) + "," + ((d.y - d.py)+h/2) + ")"; 
			        	return "translate(" + d.x + "," + d.y + ")";
			        });

 			    link.attr("x1", function(d) { return d.source.x; })
 			        .attr("y1", function(d) { return d.source.y; })
 			        .attr("x2", function(d) { return d.target.x; })
 			        .attr("y2", function(d) { return d.target.y; });
			    
			  }
			}
		});
	});
});
</script>
</head>
<body>
<form method="">
	{% csrf_token %}
	{{ form.as_p}}
	<input type="submit" value="find">
</form>
<div id="result"></div>
<script type="text/javascript" src="{{ STATIC_URL }}d3/d3.js"></script>
<script type="text/javascript" src="{{STATIC_URL}}d3/d3.geom.js"></script>
<script type="text/javascript" src="{{STATIC_URL}}d3/d3.layout.js"></script>
</body>
</html>
